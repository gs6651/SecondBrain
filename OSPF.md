
`OSPF does routing based on node-ID (i.e. Router ID in link-state graph) NOT based on destination, like BGP do.`

### LSA Types: OSPF database commands
    - Router
    - Network
    - Summary
    - ASBR-Summary
    - External
    - ---- not in use ----
    - NSSA-External
    - `show ip ospf database <LSA Type> <ip>`

### Hello Packet "Attributes":
    - (Which MUST match to form Neighbor / Adjacency)
    - Authentication
    - Area ID
    - Prefix
    - Subnet Mask
    - Network Type (Broadcast, P2P, etc.)
    - Stub Flag (NSSA, Stub, etc.)
    - Timers (Hello's & Dead)

### Hello Packet Contains:
    - Local Router ID
    - Router IDs of other Neighbor
    - Local Subnet Mask
    - Local Interface Priority
    - DR / BDR information on that link
    - Authentication type & password
    - Hello & Dead timers
    - Stub Flags and other capabilities
    - Does not contains Interface IP

### OSPF Adjacency States:
    - Down: No Hellos send
    - Attempt: When neighbors configured Manually // Unicast hello // NBMA
    - In-it: Sent Hello, but neighbor didn't ACK
    - 2-way: Received Hello from neighbor with my RID. DR/BDR
    - Ex-start: Master/Slave, sequence no. for DBD
    - Exchange: MTU, Stub Flag, LSDB Exchange, Topology Tables exchange
    - Loading: Information about particular LSA,
    - Full: Synchronized LSDB


### Path Selection:
    - O: OSPF
    - O IA: OSPF Inter-Area
    - E1: External Type-1
    - N1: NSSA Type-1
    - E2: External Type-2
    - N2: NSSA Type-2


### Virtual Links:
    - Multi-hop unicast adjacency
    - Carries only "Control-Plane" traffic
    - Highest cost can be 65535
    - No "Hellos" are exchanged
    - End points must be reachable via normal area ONLY  (Can't be any kind of Stub)

### Filtering Methods in OSPF:
    - Two different ways :
    - Intra-Area Filters:
    - Won't install in routing table but will be there in LSDB
    - "distribute-list"
    - "distribute-list" with "route-map"
    - By changing the AD to unknown i.e. 255

### Inter-Area Filters:
    -   Won't even install in LSDB
    -   Type-3 LSA filtering using 'area < > range' on ABR
    -   Type-3 LSA filtering using "filter-list" command
    -   LSA Flooding Filtering


## LSAs (Link State Advertisements)
### Router LSA (Type-1)
    - V-Bit = If it's a endpoint of virtual link
    - B-Bit = If it's ABR
    - E-Bit = If it's ASBR
    - Number of Links on Router running OSPF

### Network LSA (Type-2)
    - Generated by DR on-behalf-of Network
    - Contains the list of all connected Routers
    - It helps to draw a topological view of network, which will be complex if we use Type-1 only
    - It tells about the network-mask

### Summary LSA (Type-3)
    - From Backbone to Non-Backbone
    - Connected routes
    - Intra-area routes
    - Inter-area routes
    - From Non-backbone to Backbone
    - Connected routes
    - Intra-area routes
    - NO Inter-area (If you see this, it means backbone area is discontinuous, which is not allowed in OSPF)

### ASBR Summary LSA (Type-4)
    - Contains the Router-ID of ASBR
    - Flooded throughout the OSPF domain
    - Type-3 & Type-4 shares the same packet format

### External LSA (Type-5)
    - Bit-E = If set, then E2 else E1

### NSSA LSA (Type-7)
    - P-Bit = 0 mean No 7/5, 1 means yes
    - If NSSA ASBR is also NSSA ABR then P-Bit will be 0
    - If multiple NSSA ABR, then the highest router-ID will do 7/5 conversion.

### What if the Router got multiple instances for the same LSA ???
 - Higher sequence no. will be more recent
 - Higher checksum
 - Compare Age, the one with MaxAge (3600s) is recent
 - If the Age difference is more than 15 minutes (MaxDiff), Lower Age wins
 - If it's all the same, Accept all. ðŸ˜œ

### OSPF Network Types:
 - Total = 6
 - Broadcast: DR/BDR
 - Non-Broadcast: DR/BDR (Unicast Hellos, Manually defined neighbors)
 - P2P:
 - P2MP: Special Next-hop processing
 - P2MP Non-Broadcast: Set Cost to Particular neighbor
 - Loopback:
 
Only Network Type Broadcast & Non-Broadcast use Type-2 LSA. Rest Don't.


# LSA & Area Table: PENDING 
 
Type 1
Type 2
Type 3
DEFAULT
Type 4
Type 5
Type 7
Area 0
YES
YES
YES
NO
YES
YES
NO
NORMAL
YES
YES
YES
NO
YES
YES
NO
STUB
YES
YES
YES
YES
NO
NO
NO
Totally STUB
YES
YES
NO
YES
NO
NO
NO
NSSA
YES
YES
YES
NO
NO
NO
YES
Totally NSSA
YES
YES
NO
YES
NO
NO
YES



LSA's Explanation:
  




Traffic Engineering in OSPF:
STUB:
Longest prefix match (# area X no-summary) For INTER-AREA ROUTES only
# area X default-cost (For EXTERNAL Routes Only)

### Option Fields in Hello:
 - DN - For Loop Avoidance in L3 VPN
 - O - Originating router supports Opaque LSAs : 9, 10 & 11
 - DC - Originating router supports OSPF over Demand Circuits
 - L - Link-Local-Signaling (For Graceful Restart or I-SPF)
 - N - Supports Type-7 LSA. When N bit is set to 1, E must be set to 0
 - P - Only in NSSA, when set to 1, NSSA ABR will translate from Type-7 to Type-5
 - MC - Multicast OSPF (NOT Supported)
 - E - External-Routing-Capabilities, (When Set, Means External LSAs are allowed in this area)
 - MT - Multi-topology OSPF


### Packet Types:
- DBD Packet:
    - Interface MTU
    - Option Fields
    - I-bit = Initial
    - M-bit = More
    - M/S-bit = Master/Slave (1=Master, 0=Slave)
    - DBD Sequence Number - Only Master will increment it
    - LSA Header
- LSU Packet
    - Contains LSA
    - Implements Flooding : Several LSAs in single packet
- LSR Packet
    - Used to retrieve that precise piece of database information that is missing
    - It's used after DBD is finished
    - LSA Type : Type-1 etc.
    - LSA ID : specific LSA
    - Advertising Router



## Remembering Old DR:
    What Cisco seems to do is an attempt to provide a smoother, graceful transition from the old LSA-2 that existed during the partitioned network to the new LSA-2 originated by the newly elected DR. So what Cisco's OSPF implementation does is this:
    The routers will remember who the old DR was because its ID is the Advertising Router ID of its old LSA-2 they want to gracefully migrate from.
    During a transition period of 3 minutes, routers will advertise two links to transit networks in their own LSA-1, both the link to the old LSA-2 and the link to the new LSA-2. Old DRs will not flush their old LSA-2 during this transition period.
    After the transition period has passed, old DRs will flush their LSA-2, upon which the remaining routers will forget about the old DR and refresh their LSA-1, this time pointing only to the new LSA-2 originated by the new DR.

    From <https://learningnetwork.cisco.com/thread/87029>


## Misc.
- "Updates" are sent to Multicast address (224.0.0.5) for P2P links
- But in case of P2MP & VLs it's sent to adjacency's interface IP address.
- While for Broadcast address used is 224.0.0.6 (for Oblivious reason)
- LSU containing `retransmission` are always unicast
- Delayed LSA's are used to minimize the LSA flooding so that multiple LSA's can be sent in one single packet, but delay timer MUST be - less than RxmtInterval to avoid unnecessary flooding.
- Direct LSA's always send immediately and always are unicast ONLY. Will be send in two cases:
- A duplicate LSA from neighbor
- LSA's age is MaxAge
- LSA contains 3 values :
  - Sequence No.: 32-bit, 0x80000001 -to- 0x7FFFFFFF
  - Checksum: 16-bit integer, Calculated every 5 minute, entire LSA (except Age field)
  - Age:  3600 seconds = 1 hour
LSA Group Pacing: 240 seconds = 4 minutes
"Routing bit set on this LSA" means : LSA is valid AND route is in the routing table.
Passive Interface means, Router will not hear hellos, but will advertise that interface in OSPF domain.
Hot-Potato: EXTERNAL comes into account (E2)
Cold-Potato: INTERNAL comes into account (E1)
When "Capability Transit" is ON and a virtual link exists and the route to reach the destination is lower, we can use a non-backbone area to achieve it. Rules can be broken. Capability-Transit: https://ccieblog.co.uk/ospf/ospf-capability-transit
When summarizing, OSPF process creates a local "discard" route i.e. route to null0
It means If the longest match is a summary, discard it. You should have a more specific route. Actually we're trying to hide the topology
#no discard-route
Internal Summary can be done at ABR (only) who knows the LSA-1 (Router LSA). e.g. can summarize LSA-1 to LSA-3 but not LSA-3 to LSA-3.  #area X range
External Summary can be done at ASBR (only), who is the originator. #summary-address
Sham-Link:
Multi-hop "Unicast" adjacency
Loopback's of PE's MUST be advertise in MPLS (BGP) cloud but NOT via Backdoor
Type-2 LSA (Network) helps in describing the mathematical view, which will help other routers (in that area only) to understand the topology. Mathematical view or graphical view is required to build a tree, And tree means GUARANTEED loop free design. In other words It's not used to cut down the number of hellos but to simplify calculation of SPF. This can be achieved with the help of Type-1 LSA as well, but to sense the graph of the network will be a complex process. Moreover, Network LSA is generated by DR on-behalf of Network.
 
Another reason, To fully describe the topology, every router would need to generate an LSA describing its connection to all other routers. This would result in n(n-1) / 2 LSAs.
 
Most Importantly, LSA-2 tells about the network mask, which LSA-1 doesn't tell. ðŸ™‚
Ip ospf mtu-ignore



### How does SPF work?
After flooding information to network, all routers know about each other and links between them in the form of {neighbor, cost} Pairs
 
SPF Calculation maintains two tables:
PATH List: A list of nodes that are known to be on the shortest path to destination
TENT List: A list of nodes that might or might not be on the shortest path to destination
 
Each list is table of {router, distance, next-hop}
 
Router = Router-ID of the node
Distance = Cost to get the node
Next-Hop = It's the router you go through to reach the node
 
Step 1. Put "self" on the PATH list with a distance of 0 and a next hop of self. The router
running the SPF refers to itself as either "self" or the root node, because this node is the root
of the shortest-path tree.
Step 2. Take the node just placed on the PATH list, and call it the PATH node. Look at the
PATH node's list of neighbors. Add each neighbor in this list to the TENT list with a next hop
of the PATH node, unless the neighbor is already in the TENT or PATH list with a lower cost.
Call the node just added to the TENT list the TENT node. Set the cost to reach the TENT node
equal to the cost to get from the root node to the PATH node plus the cost to get from the
PATH node to the TENT node. If the node just added to a TENT list already exists in the TENT
list, but with a higher cost, replace the higher-cost node with the node currently under
consideration.
Step 3. Find the neighbor in the TENT list with the lowest cost, add that neighbor to the
PATH list, and repeat Step 2. If the TENT list is empty, stop.
 
### Why Type-4 LSA ???
Receive type-5, read the ASBRs RID.  If the ASBRâ€™s RID isnâ€™t in your area graph thenâ€¦
Look for type-4 with a Link ID matching the ASBRs RID.  This type-4 was advertised by your ABR, which you can locate in your area graph, thenâ€¦
Look for type-1 for ABRs RID and calculate the path to ABR.


### Forwarding Address to 0.0.0.0 or Non-Zero:
    - OSPF is enabled on the ASBRâ€™s next hop interface AND
    - ASBRâ€™s next hop interface is non-passive under OSPF AND
    - ASBRâ€™s next hop interface is not P2P or P2MP AND
    - ASBRâ€™s next hop interface address falls under the network range specified in the router ospf command.
    - Any other conditions besides the above set the forwarding address to 0.0.0.0.


